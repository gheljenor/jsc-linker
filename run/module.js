require("colors");var nodePath=require("path"),fs=require("fs"),_=require("underscore"),handlebars=require("handlebars");!function(a,b){var c,d=[],e={},f=function(){f.push.apply(this,arguments),f.log.apply(this,arguments)};f.logs=[],f.push=function(a,b,c,d){return f.logs.unshift({file:a,event:b,state:c,data:d,time:new Date}),f.logs.length>1e3&&(f.logs.length=1e3),this},f.log=function(a,b,c,d){return"error"==b&&console.error(a,b,c,d),this};try{d[0]=function(){function a(){return g}function b(a){g=a,c(g)}function c(a){var b,c;do{b=!1;for(c in a)a[c]=a[c].replace(/\{(.*)\}/g,function(c,d){return b=!0,a[d]||d})}while(b);for(c in a)a[c]=nodePath.normalize(a[c])}function d(a){return nodePath.normalize(a.replace(h,function(a,b){return g[b]||b}))}var e=f.bind(this,"{root}/config/paths");try{e("file","start","{root}/config/paths");var g,h=/\{(.*)\}/g;e("file","end","{root}/config/paths")}catch(i){e("error","init",i)}return{getPaths:a,setPaths:b,normalizePath:d}}(),d[1]=function(a){function b(a){e=a}function c(b,c){return b=a(b),"tpl"==b.split(".").pop()?(i("Reading template file: ".bold.green,(b+"."+k).green),fs.readFileSync(b+"."+k,{encoding:e})):!c&&fs.existsSync(b+".min.js")?(i("Reading minified file: ".bold.green,(b+".min.js").green),fs.readFileSync(b+".min.js",{encoding:e})):(i("Reading file: ".bold.green,(b+".js").green),fs.readFileSync(b+".js",{encoding:e}))}var d=f.bind(this,"{root}/fs/read-file");try{d("file","start","{root}/fs/read-file");var e="UTF-8";d("file","end","{root}/fs/read-file")}catch(g){d("error","init",g)}return{setEncoding:b,reader:c}}(d[0].normalizePath),d[2]=function(){var a=f.bind(this,"{root}/directives/directives.list");try{a("file","start","{root}/directives/directives.list");var b={},c=[];a("file","end","{root}/directives/directives.list")}catch(d){a("error","init",d)}return{directives:b,depNames:c}}();var g=d[2].directives,h=d[2].depNames;delete d[2].directives,delete d[2].depNames,d[3]=function(){var a=f.bind(this,"{root}/directives/override");try{a("file","start","{root}/directives/override");var b={};g.override={before:function(a,c,d,e){return d&&(b={}),a.replace(e,function(a,c,d){return d=d.split("#")[0],b[d]?a.replace(d,b[d]):a})},line:function(a){return a=a.split("#"),b[a[0]]=a[1],{inner:a[0],outer:a[1]}}},a("file","end","{root}/directives/override")}catch(c){a("error","init",c)}}(),d[4]=function(){var a=f.bind(this,"{root}/directives/load");try{a("file","start","{root}/directives/load"),g.load={line:function(a){return a},block:function(a,b){b.parseQueue(a)}},h.push("load"),a("file","end","{root}/directives/load")}catch(b){a("error","init",b)}}(),d[5]=function(a){var b=f.bind(this,"{root}/directives/require");try{b("file","start","{root}/directives/require"),g.require={before:function(b,c,d,e){return b.replace(e,function(b,c,d){return"require"!=c?b:a(d)})}},b("file","end","{root}/directives/require")}catch(c){b("error","init",c)}}(d[1].reader),d[6]=function(){var a=f.bind(this,"{root}/directives/include");try{a("file","start","{root}/directives/include"),g.include={line:function(a){return a},block:function(a,b){b.parseQueue(a,"library")}},a("file","end","{root}/directives/include")}catch(b){a("error","init",b)}}(),d[7]=function(){var a=f.bind(this,"{root}/directives/template");try{a("file","start","{root}/directives/template"),g.template={before:null,line:function(a){return a},block:function(a,b){b.parseQueue(a,"template")}},h.push("template"),a("file","end","{root}/directives/template")}catch(b){a("error","init",b)}}(),d[8]=function(){var a=f.bind(this,"{root}/directives/uses");try{a("file","start","{root}/directives/uses"),g.uses={before:null,line:function(a){return a=a.split("#"),{file:a[0],inner:a[1]}},block:function(a,b){var c=a.map(function(a){return a.file});b.parseQueue(c)}},h.push("uses"),a("file","end","{root}/directives/uses")}catch(b){a("error","init",b)}}(),d[9]=function(){var a=f.bind(this,"{root}/directives/import");try{a("file","start","{root}/directives/import"),g.import={line:function(a){a=a.split("#");var b=a[1].split(" as ");return{file:a[0],inner:b[1]||b[0],outer:b[0]}},block:function(a,b){var c=a.map(function(a){return a.file});b.parseQueue(c)}},h.push("import"),a("file","end","{root}/directives/import")}catch(b){a("error","init",b)}}(),d[10]=function(){var a=f.bind(this,"{root}/directives/export");try{a("file","start","{root}/directives/export"),g.export={line:function(a){return a=a.split(" as "),{inner:a[0],outer:a[1]||a[0]}}},h.push("export"),a("file","end","{root}/directives/export")}catch(b){a("error","init",b)}}(),d[11]=function(){var a=f.bind(this,"{root}/directives/internal");try{a("file","start","{root}/directives/internal"),g.internal={line:function(a){return a=a.split(" as "),{inner:a[0],outer:a[1]||a[0]}}},a("file","end","{root}/directives/internal")}catch(b){a("error","init",b)}}(),d[12]=function(){var a=f.bind(this,"{root}/directives/external");try{a("file","start","{root}/directives/external"),g.external={line:function(a){return a=a.split(" as "),{inner:a[0],outer:a[1]||a[0]}}},a("file","end","{root}/directives/external")}catch(b){a("error","init",b)}}(),d[13]=function(){var a=f.bind(this,"{root}/directives/global");try{a("file","start","{root}/directives/global"),g.global={line:function(a){return a=a.split(" as "),{inner:a[0],outer:a[1]||a[0]}}},a("file","end","{root}/directives/global")}catch(b){a("error","init",b)}}(),d[14]=function(){var a=f.bind(this,"{root}/directives/refs");try{a("file","start","{root}/directives/refs"),g.refs={line:function(a){return a}},a("file","end","{root}/directives/refs")}catch(b){a("error","init",b)}}(),d[15]=function(){var a=f.bind(this,"{root}/directives/test");try{a("file","start","{root}/directives/test"),g.test={line:function(a){return a},block:function(a,b,c){a.forEach(function(a){b.add("test",{tests:{file:c.name},name:a})})}},a("file","end","{root}/directives/test")}catch(b){a("error","init",b)}}(),d[16]=function(){var a=f.bind(this,"{root}/directives/directives");try{a("file","start","{root}/directives/directives"),a("file","end","{root}/directives/directives")}catch(b){a("error","init",b)}}(),d[17]=function(a){function b(b,c,f){if(f&&(h={}),h[b])return h[b];var k="tpl"==b.split(".").pop(),l=k?e:d,o=a(b,f),p={name:b,type:k?"template":"submodule"};p.file=m(o,p,f,l),h[b]=p;for(var q,r,s;q=l.exec(p.file);){if(!g[q[1]])throw new TypeError("Unknown directive: "+q[1]);r=g[q[1]],r.line&&(p[q[1]]||(p[q[1]]=[]),s=p[q[1]],s.push(r.line(q[2],f)))}var t=[],u={},v={parseQueue:function(a,b){if(b||(b=function(a){v.add(a.type||"submodule",a)}),_.isString(b)){var c=b;b=function(a){v.add(c,a)}}a.forEach(function(a){u[a]||(u[a]={name:a,cbs:[]},t.push(u[a])),u[a].cbs.push(b)})},add:function(a,b){c[a]||(c[a]={files:{},index:0}),c[a].files[b.name]||(c[a].files[b.name]=b,b.order=c[a].index++)}};for(var w in g)g[w].block&&p[w]&&g[w].block(p[w],v,p,c);if(j)for(var x in p)"file"!=x&&i(x.bold.blue,JSON.stringify(p[x],null,2).white);return n(t,c),p}var c=f.bind(this,"{root}/parser/reader");try{c("file","start","{root}/parser/reader");var d=/\/\/\#([^ \n]+) ?(.*?)\s*$/gm,e=/\{\{!\#([^ \}]*) ?(.*?)\}\}/g,h={},k={};for(var l in g)g[l].before&&(k[l]=g[l].before);var m=function(a,b,c,d){for(var e in k){var f=k[e](a,b,c,d);if(f!==a)return m(f,b,c,d)}return a},n=function(a,c){var d,e,f;for(d=0,e=a.length;e>d;d++)f=b(a[d].name,c,!1),a[d].cbs.forEach(function(a){a(f)})};c("file","end","{root}/parser/reader")}catch(o){c("error","init",o)}return{parseFile:b}}(d[1].reader),d[18]=function(a){function b(b,c){b=a(b),i("Writing file: ".bold.yellow,b.yellow),fs.writeFileSync(b,c)}var c=f.bind(this,"{root}/fs/write-file");try{c("file","start","{root}/fs/write-file"),c("file","end","{root}/fs/write-file")}catch(d){c("error","init",d)}return{writer:b}}(d[0].normalizePath),d[19]=function(a){function b(b){a(b.entry+".module.json",JSON.stringify(b,!0,2)),b.library&&c(b),b.i18n&&d(b),e(b)}function c(b){var c=b.library.files,d=[];for(var e in c)d.push("//! ---- Library file: "+e+"\n"+c[e].file+"\n");a(b.entry+".lib.js",d.join(";\n"))}function d(b){var c="var I18N = "+JSON.stringify(b.i18n)+";";a(b.entry+".i18n.js",c)}function e(b){var c=b.submodule.files,d=c[b.entry].order,e=h(b),f=[];for(var i in c)f[c[i].order]=g(c[i],b);var j="(function(window, __module){ var __, __m=[],__export={};\nvar _runLogger = function(){_runLogger.push.apply(this, arguments);_runLogger.log.apply(this, arguments);};_runLogger.logs = [];_runLogger.push = function(file, event, state, data){_runLogger.logs.unshift({ file: file, event: event, state: state, data: data, time: new Date() });if (_runLogger.logs.length > 1000) _runLogger.logs.length = 1000;return this;};_runLogger.log = function(file, event, state, data){if (event == 'error') console.error(file, event, state, data);return this;};try {\n"+f.join("\n")+"\n"+e+"\nfor (__ in __m["+d+"]) __export[__] = __m["+d+"][__];\nfor (__ in __export) (__module || window)[__] = __export[__];\n__ = __m = __module = null;\nreturn __export;}catch(e){ _runLogger('module', 'error', 'startup', e); }})(typeof window !== 'undefined' ? window : typeof exports !== 'undefined' ? exports : {}, typeof __module !== 'undefined'?__module:null);";a(b.entry+".module.js",j)}function g(a,b){var c="__m["+a.order+"]=(function(",d=[];return a.uses&&(d=d.concat(a.uses.map(function(a){return a.inner}))),a.import&&(d=d.concat(a.import.map(function(a){return a.inner}))),c+=d.join(","),i(a),c+="){ var __, __m, __export, __module;\n",c+="\n//! ---- File: "+a.name+"\n"+a.file+"\n",a.global&&(c+=a.global.map(function(a){return"window."+a.outer+"="+a.inner+";"}).join("\n")+"\n"),(a.export||a.internal||a.external)&&(c+="return {"+(a.export||[]).concat(a.internal||[]).concat(a.external||[]).map(function(a){return a.outer+": "+a.inner}).join(",")+"};"),c+="})(",d=[],a.uses&&(d=d.concat(a.uses.map(function(a){return"__m["+b.submodule.files[a.file].order+"]"}))),a.import&&(d=d.concat(a.import.map(function(a){return"__m["+b.submodule.files[a.file].order+"]."+a.outer}))),c+=d.join(","),c+=");\n",a.external&&(c+=a.external.map(function(b){return"__export."+b.outer+"= __m["+a.order+"]."+b.outer+";\n"})),(a.internal||a.external)&&(c+="var "+(a.internal||[]).concat(a.external||[]).map(function(b){return b.outer+"=__m["+a.order+"]."+b.outer}).join(", ")+";\n",c+=(a.internal||[]).concat(a.external||[]).map(function(b){return"delete __m["+a.order+"]."+b.outer+";\n"}).join("")),c}function h(a){if(!a.template)return"";var b,c,d=a.template.files,e={};for(var f in d)e[f]=handlebars.precompile(d[f].file);var g="var TPL = (function(){_runLogger('module', 'file', 'start', 'templates');var tpl,template = Handlebars.template,templates = Handlebars.templates = Handlebars.templates || {},partials = Handlebars.partials = Handlebars.partials || {};\n";for(f in e)b=f.replace(".tpl",""),c=f.replace(/\.(open|close)$/,""),g+="\n//! ---- Template: "+b+"\n",d[c].import?(g+="(function(imports){\n",g+="var tpl = "+e[f]+";\n",g+="var tmp = tpl.main;\n",g+="tpl.main = function(depth0, helpers, partials, data){ return tmp.call(this, _.extend(depth0, imports), helpers, partials, data);}\n",g+="partials['"+b+"'] = templates['"+b+"'] = template(tpl);\n",g+="})({"+d[f].import.map(function(b){return b.inner+": __m["+a.submodule.files[b.file].order+"]."+b.outer}).join(",")+"});\n"):g+="partials['"+b+"'] = templates['"+b+"'] = template("+e[f]+");\n";return g+="_runLogger('module', 'file', 'end', 'templates');",g+="return templates;})();"}function i(a){a.file="\nvar runLogger = _runLogger.bind(this, '"+a.name+"');\ntry{\nrunLogger('file', 'start', '"+a.name+"');\n"+a.file+"\nrunLogger('file', 'end', '"+a.name+"');\n}catch(e){ runLogger('error', 'init', e); }"}var j=f.bind(this,"{root}/parser/writer");try{j("file","start","{root}/parser/writer"),j("file","end","{root}/parser/writer")}catch(k){j("error","init",k)}return{writeModule:b}}(d[18].writer),d[20]=function(){function a(a,b){function c(a){var b,d,e,f,g=r.indexOf(a);if(~g)return i("Ring structure found: ".bold.red),i(r.slice(g).join("\n").yellow),p=!1,!1;r.push(a),d=q[a];for(b in d.links){if(!q[b])return i("Not found file: ".bold.red+b.yellow+", required in file ".bold.red+a.yellow),p=!1,!1;for(e=0,f=d.links[b].length;f>e;e++)if(!~q[b].vars.indexOf(d.links[b][e]))return i("Variable ".bold.red+d.links[b][e].yellow+" required in file ".bold.red+a.yellow+" from file ".bold.red+b.yellow+" is not found".bold.red),p=!1,!1;if(!c(b))return!1}return r.pop(),!0}var d,e,f,g,j,k,l,m,n,o=a.submodule.files,p=!0,q={};for(e in o){d=_.pick(o[e],h),n={links:{},vars:[]};for(g in d)for(f=d[g],j=0,k=f.length;k>j;j++)l=_.isString(f[j])&&f[j]||f[j].file,m=!_.isString(f[j])&&f[j].outer,l?(n.links[l]||(n.links[l]=[]),m&&n.links[l].push(m)):m&&n.vars.push(m);q[e]=n}var r=[];return c(b),p&&i("Validation success.".bold.cyan),p}var b=f.bind(this,"{root}/parser/validate");try{b("file","start","{root}/parser/validate"),b("file","end","{root}/parser/validate")}catch(c){b("error","init",c)}return{validateModule:a}}(),d[21]=function(a,b){function c(){var c=a();if(!c.i18n)return!1;var d={},e=b(c.i18n);return fs.readdirSync(e).filter(function(a){return 2!=a.length?!1:".svn"==a?!1:!0}).forEach(function(a){var b=d[a]={},c=nodePath.resolve(e,a);fs.readdirSync(c).filter(function(a){return".svn"==a?!1:"json"!=a.split(".").pop()?!1:!0}).sort(function(a,b){return"old.obsolete.json"==a?-1:"old.obsolete.json"==b?1:"old.raw.json"==a?-1:"old.raw.json"==b?1:0}).forEach(function(d){i("Reading i18n file:".bold.green,a.green,d.green),_.extend(b,JSON.parse(fs.readFileSync(nodePath.resolve(c,d),{encoding:"UTF-8"}).replace(/\/\/.*$/gm,"")))})}),d}var d=f.bind(this,"{root}/parser/i18n");try{d("file","start","{root}/parser/i18n"),d("file","end","{root}/parser/i18n")}catch(e){d("error","init",e)}return{i18nReader:c}}(d[0].getPaths,d[0].normalizePath),d[22]=function(a,b,c,d,e,g,h){function i(a,b,c){var d=nodePath.resolve(a),e=require(d);e.paths.root=nodePath.normalize(nodePath.dirname(a)),/\.test\.json$/.test(a)&&e.paths.i18n&&delete e.paths.i18n;var f=e.paths.i18n||!1;e.paths.i18n&&delete e.paths.i18n,Array.isArray(e.build)||(e.build=[e.build]);for(var g=0,h=e.build.length;h>g;g++)g==h-1&&f&&(e.paths.i18n=f),j({paths:e.paths,path:e.build[g],encoding:e.encoding||"UTF-8",templateExt:e.templateExt||"hbs"},b,c)}function j(b,f,i){f||(f=console.log.bind(console)),l=f,n=i||!1,m("Building module: ".cyan.bold,b.path.cyan),a(b.paths),c(b.encoding),o=b.templateExt||"hbs";var j={type:"module",entry:b.path,paths:b.paths,submodule:{index:0,files:{}}},k=d(b.path,j,!0);j.submodule.files[k.name]=k,k.order=j.submodule.index++;var p=h();p&&(j.i18n=p),g(j,k.name)&&e(j)}var k=f.bind(this,"{root}/linker");try{k("file","start","{root}/linker");var l,m=function(){return l.apply(this,arguments)},n=!1,o="hbs";k("file","end","{root}/linker")}catch(p){k("error","init",p)}return{build:i,linker:j,log:m,verbose:n,templateExt:o}}(d[0].setPaths,d[0].normalizePath,d[1].setEncoding,d[17].parseFile,d[19].writeModule,d[20].validateModule,d[21].i18nReader);var i=d[22].log,j=d[22].verbose,k=d[22].templateExt;delete d[22].log,delete d[22].verbose,delete d[22].templateExt;for(c in d[22])e[c]=d[22][c];for(c in e)(b||a)[c]=e[c];return c=d=b=null,e}catch(l){f("module","error","startup",l)}}("undefined"!=typeof window?window:"undefined"!=typeof exports?exports:{},"undefined"!=typeof __module?__module:null);